%%inherit(file="/_main.haml")/
-!
    import os
-
    group = repo.group
    prev = repo.git.revparse_single(commit.hex + '^')
    diff = repo.git.diff(prev, commit)

%ol.breadcrumb
    %li
        %a(href='/') %img(src="/img/git-logo.png")
    %li
        %a(href=url_for('group', group=group)) &= group.name
    %li
        %a(href=url_for('repo', repo=repo)) &= repo.name
    
    %li
        &= commit.hex[:8]

-
    mode_to_class = {
        '+': 'git-diff-plus',
        '-': 'git-diff-minus',
        ' ': 'git-diff-same',
        '>': 'git-diff-right',
        '<': 'git-diff-left',
    }

- for patch in diff:

    .panel.panel-default

        .panel-heading
            .pull-right
                %code ${prev.hex[:8]}
                ..
                %code ${commit.hex[:8]}

            &= patch.new_file_path

        %table.git-diff - for hunk in patch.hunks:

            %tr.git-diff-target
                %td ...
                %td ...
                %td @@ -${hunk.old_lines},${hunk.old_start} +${hunk.new_lines},${hunk.new_start} @@

            -
                old_line = hunk.old_lines
                new_line = hunk.new_lines
            - for mode, line in hunk.lines:
                %tr(class_=mode_to_class[mode])
                    %td.git-diff-lineno - if mode != '+':
                        = old_line
                        - old_line += 1
                    %td.git-diff-lineno - if mode != '-':
                        = new_line
                        - new_line += 1
                    %td.git-diff-content &= mode + line.strip('\n')

-#
    %pre
        :plain
            index ${prev.hex[:8]}..${commit.hex[:8]}
            --- ${patch.old_file_path}
            +++ ${patch.new_file_path}
        - for hunk in patch.hunks:
            :plain @@ ${hunk.old_lines},${hunk.old_start} ${hunk.new_lines},${hunk.new_start} @@
            - for mode, line in hunk.lines: :plain ${mode}${line.rstrip('\n')}

