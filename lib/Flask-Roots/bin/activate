#!/bin/bash

APP_BIN="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
APP_ROOT="$(dirname "$APP_BIN")"

# Create a Python virtual environment.
VENV="$APP_ROOT/var/venv-$(uname)-$(arch)"
if [[ ! -e "$VENV/bin/python" ]]
then

    # Make sure we even have virtualenv.
    if [[ ! -e "$APP_BIN/virtualenv" ]]
    then
        curl -o "$APP_BIN/virtualenv" https://raw.github.com/pypa/virtualenv/master/virtualenv.py
        chmod +x "$APP_BIN/virtualenv"
    fi

    # Create it.
    mkdir -p "$VENV"
    "$APP_BIN/virtualenv" --no-site-packages --distribute "$VENV"
fi
. "$VENV/bin/activate"

# Drop into Python virtualenv.
. "$VENV/bin/activate"


# All variables are set below this point so that the critical ones will
# get reset when the venv is deactivated.

export PATH="$APP_ROOT/bin:$VENV/bin:$PATH"

export PYTHONPATH="$PYTHONPATH:$APP_ROOT"

# Ruby gems.
export GEM_HOME="$VENV"
export GEM_PATH=""

# Node packages.
export NPM_CONFIG_GLOBAL="true"
export NPM_CONFIG_PREFIX="$VENV"

# Bower packages.
export bower_cwd="$VENV"
